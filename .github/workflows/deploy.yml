name: Deploy to Lightsail (build on server, b64 key)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.LIGHTSAIL_HOST }}
      USER: ${{ secrets.LIGHTSAIL_USER }}
      KEY_B64: ${{ secrets.LIGHTSAIL_SSH_KEY_B64 }}
      KNOWN_HOSTS: ${{ secrets.LIGHTSAIL_KNOWN_HOSTS || '' }}

    steps:
      - name: Validate required secrets
        shell: bash
        run: |
          [ -n "$HOST" ]    || { echo "Missing LIGHTSAIL_HOST"; exit 1; }
          [ -n "$USER" ]    || { echo "Missing LIGHTSAIL_USER"; exit 1; }
          [ -n "$KEY_B64" ] || { echo "Missing LIGHTSAIL_SSH_KEY_B64"; exit 1; }

      - name: Prepare SSH (decode + validate)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.ssh"; chmod 700 "$HOME/.ssh"

          # write decoded key
          echo "$KEY_B64" | base64 -d > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          # fail fast if malformed or passphrase-protected
          ssh-keygen -y -f "$HOME/.ssh/id_ed25519" > /dev/null

          # trust host - use provided known_hosts if available
          if [ -n "$KNOWN_HOSTS" ]; then
            echo "Using provided KNOWN_HOSTS secret"
            printf '%s\n' "$KNOWN_HOSTS" >> "$HOME/.ssh/known_hosts"
          else
            echo "KNOWN_HOSTS not set - will use SSH with StrictHostKeyChecking=accept-new"
            echo "For better security, consider setting LIGHTSAIL_KNOWN_HOSTS secret"
            echo "Run locally: ssh-keyscan -H $HOST"
          fi

      - name: Test SSH connectivity
        run: |
          # Use accept-new to accept host key on first connection if KNOWN_HOSTS not set
          STRICT_MODE="${KNOWN_HOSTS:+yes}"
          STRICT_MODE="${STRICT_MODE:-accept-new}"
          echo "Using StrictHostKeyChecking=$STRICT_MODE"

          ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=$STRICT_MODE \
            "$USER@$HOST" 'echo ok'

      - name: Trigger remote deploy
        run: |
          # Use accept-new to accept host key on first connection if KNOWN_HOSTS not set
          STRICT_MODE="${KNOWN_HOSTS:+yes}"
          STRICT_MODE="${STRICT_MODE:-accept-new}"

          ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=$STRICT_MODE \
            "$USER@$HOST" 'bash -lc "~/buckEuchre/deploy.sh"'
