- name: Prepare SSH (base64, validated)
  shell: bash
  run: |
    set -euo pipefail
    mkdir -p "$HOME/.ssh"; chmod 700 "$HOME/.ssh"
    echo "${{ secrets.LIGHTSAIL_SSH_KEY_B64 }}" | base64 -d > "$HOME/.ssh/id_ed25519"
    chmod 600 "$HOME/.ssh/id_ed25519"
    # fail fast if the key is malformed or passphrase-protected
    ssh-keygen -y -f "$HOME/.ssh/id_ed25519" > /dev/null

    if [ -n "${{ secrets.LIGHTSAIL_KNOWN_HOSTS || '' }}" ]; then
      printf '%s\n' "${{ secrets.LIGHTSAIL_KNOWN_HOSTS }}" >> "$HOME/.ssh/known_hosts"
    else
      ssh-keyscan -H "${{ secrets.LIGHTSAIL_HOST }}" >> "$HOME/.ssh/known_hosts"
    fi

- name: Test SSH
  run: |
    ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes \
      "${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}" 'echo ok'

- name: Trigger remote deploy
  run: |
    ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes \
      "${{ secrets.LIGHTSAIL_USER }}@${{ secrets.LIGHTSAIL_HOST }}" 'bash -lc "~/buckEuchre/deploy.sh"'
