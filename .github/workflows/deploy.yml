name: Deploy to Lightsail (build on server, b64 key)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.LIGHTSAIL_HOST }}
      USER: ${{ secrets.LIGHTSAIL_USER }}
      KEY_B64: ${{ secrets.LIGHTSAIL_SSH_KEY_B64 }}
      KNOWN_HOSTS: ${{ secrets.LIGHTSAIL_KNOWN_HOSTS || '' }}

    steps:
      - name: Validate required secrets
        shell: bash
        run: |
          [ -n "$HOST" ]    || { echo "Missing LIGHTSAIL_HOST"; exit 1; }
          [ -n "$USER" ]    || { echo "Missing LIGHTSAIL_USER"; exit 1; }
          [ -n "$KEY_B64" ] || { echo "Missing LIGHTSAIL_SSH_KEY_B64"; exit 1; }

      - name: Prepare SSH (decode + validate)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.ssh"; chmod 700 "$HOME/.ssh"

          # write decoded key
          echo "$KEY_B64" | base64 -d > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"

          # fail fast if malformed or passphrase-protected
          ssh-keygen -y -f "$HOME/.ssh/id_ed25519" > /dev/null

          # trust host - use provided known_hosts if available
          if [ -n "$KNOWN_HOSTS" ]; then
            echo "Using provided KNOWN_HOSTS secret"
            printf '%s\n' "$KNOWN_HOSTS" >> "$HOME/.ssh/known_hosts"
          else
            echo "KNOWN_HOSTS not set - will use SSH with StrictHostKeyChecking=accept-new"
            echo "For better security, consider setting LIGHTSAIL_KNOWN_HOSTS secret"
            echo "Run locally: ssh-keyscan -H $HOST"
          fi

      - name: Diagnose network connectivity
        run: |
          echo "=== Network Diagnostics for $HOST ==="
          echo ""

          echo "1. DNS Resolution:"
          if host "$HOST"; then
            echo "✓ DNS resolves"
            IP=$(host "$HOST" | grep "has address" | awk '{print $4}' | head -1)
            echo "  Resolved to: $IP"
          else
            echo "✗ DNS resolution failed"
            exit 1
          fi

          echo ""
          echo "2. ICMP Ping (if allowed):"
          ping -c 3 -W 2 "$HOST" || echo "  ICMP blocked or host unreachable (this is often blocked, not critical)"

          echo ""
          echo "3. TCP Port 22 connectivity:"
          echo "  Attempting to connect to $HOST:22 with 10s timeout..."
          if timeout 10 bash -c "cat < /dev/null > /dev/tcp/$HOST/22" 2>&1; then
            echo "✓ Port 22 is REACHABLE"
          else
            echo "✗ Port 22 is NOT reachable (Connection timed out or refused)"
            echo ""
            echo "This means GitHub Actions cannot connect to your Lightsail instance."
            echo "Possible causes:"
            echo "  1. Lightsail instance is stopped/terminated"
            echo "  2. Security group/firewall blocking GitHub Actions IPs"
            echo "  3. Lightsail public IP changed"
            echo "  4. Network routing issue"
            echo ""
            echo "To fix, check your AWS Lightsail console:"
            echo "  - Verify instance is running"
            echo "  - Check Networking > Firewall > SSH rule allows 0.0.0.0/0 or GitHub IPs"
            echo "  - Verify public IP matches LIGHTSAIL_HOST secret"
            exit 1
          fi

          echo ""
          echo "4. SSH Banner grab:"
          timeout 5 bash -c "echo 'SSH-2.0-Test' | nc $HOST 22" | head -1 || echo "  Could not grab SSH banner"

      - name: Test SSH connectivity
        run: |
          # Use accept-new to accept host key on first connection if KNOWN_HOSTS not set
          STRICT_MODE="${KNOWN_HOSTS:+yes}"
          STRICT_MODE="${STRICT_MODE:-accept-new}"
          echo "Using StrictHostKeyChecking=$STRICT_MODE"

          ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=$STRICT_MODE \
            "$USER@$HOST" 'echo ok'

      - name: Trigger remote deploy
        run: |
          # Use accept-new to accept host key on first connection if KNOWN_HOSTS not set
          STRICT_MODE="${KNOWN_HOSTS:+yes}"
          STRICT_MODE="${STRICT_MODE:-accept-new}"

          ssh -i "$HOME/.ssh/id_ed25519" -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=$STRICT_MODE \
            "$USER@$HOST" 'bash -lc "~/buckEuchre/deploy.sh"'
