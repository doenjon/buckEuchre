generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String           @id @default(uuid())
  email                  String?          @unique
  username               String           @unique
  passwordHash           String?
  displayName            String
  avatarUrl              String?
  oauthProvider          String?
  oauthId                String?
  emailVerified          Boolean          @default(false)
  isGuest                Boolean          @default(false)
  createdAt              DateTime         @default(now())
  lastLoginAt            DateTime         @default(now())
  receivedFriendRequests Friendship[]     @relation("Receiver")
  sentFriendRequests     Friendship[]     @relation("Requester")
  gamesCreated           Game[]           @relation("GameCreator")
  receivedInvitations    GameInvitation[] @relation("Invitee")
  sentInvitations        GameInvitation[] @relation("Inviter")
  gamePlayers            GamePlayer[]
  sessions               Session[]
  settings               UserSettings?
  stats                  UserStats?

  @@unique([oauthProvider, oauthId])
  @@index([email])
  @@index([username])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([token])
}

model UserStats {
  id             String   @id @default(uuid())
  userId         String   @unique
  gamesPlayed    Int      @default(0)
  gamesWon       Int      @default(0)
  gamesLost      Int      @default(0)
  totalBids      Int      @default(0)
  successfulBids Int      @default(0)
  failedBids     Int      @default(0)
  highestBid     Int      @default(0)
  bids2          Int      @default(0)
  bids3          Int      @default(0)
  bids4          Int      @default(0)
  bids5          Int      @default(0)
  bids2Successful Int     @default(0)
  bids2Failed     Int     @default(0)
  bids3Successful Int     @default(0)
  bids3Failed     Int     @default(0)
  bids4Successful Int     @default(0)
  bids4Failed     Int     @default(0)
  bids5Successful Int     @default(0)
  bids5Failed     Int     @default(0)
  totalTricks    Int      @default(0)
  tricksWon      Int      @default(0)
  totalPoints    Int      @default(0)
  highestScore   Int      @default(0)
  bucks          Int      @default(0)
  timesFolded    Int      @default(0)
  timesCouldFold Int      @default(0)
  totalRounds    Int      @default(0)
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gamesWon])
  @@index([gamesPlayed])
}

model UserSettings {
  id               String   @id @default(uuid())
  userId           String   @unique
  showCardOverlay  Boolean  @default(true)
  showTooltips     Boolean  @default(true)
  autoSortHand     Boolean  @default(true)
  bidSpeed         String   @default("normal")
  animationSpeed   String   @default("normal")
  soundEffects     Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  showDebugConsole Boolean  @default(false)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Friendship {
  id          String           @id @default(uuid())
  requesterId String
  receiverId  String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  receiver    User             @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  requester   User             @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, receiverId])
  @@index([requesterId, status])
  @@index([receiverId, status])
}

model GameInvitation {
  id        String           @id @default(uuid())
  gameId    String
  inviterId String
  inviteeId String
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())
  expiresAt DateTime
  game      Game             @relation(fields: [gameId], references: [id], onDelete: Cascade)
  invitee   User             @relation("Invitee", fields: [inviteeId], references: [id], onDelete: Cascade)
  inviter   User             @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)

  @@unique([gameId, inviteeId])
  @@index([inviteeId, status])
  @@index([gameId])
  @@index([expiresAt])
}

model Game {
  id          String           @id @default(uuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  status      GameStatus       @default(WAITING)
  creatorId   String
  creator     User             @relation("GameCreator", fields: [creatorId], references: [id])
  invitations GameInvitation[]
  players     GamePlayer[]
  gameState   GameState?
  rounds      Round[]

  @@index([status, createdAt])
  @@index([creatorId])
}

model GamePlayer {
  id        String   @id @default(uuid())
  position  Int
  gameId    String
  userId    String?
  guestName String?
  joinedAt  DateTime @default(now())
  score     Int      @default(0)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([gameId, position])
  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
}

model GameState {
  id        String   @id @default(uuid())
  gameId    String   @unique
  state     Json
  updatedAt DateTime @updatedAt
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
}

model Round {
  id                 String   @id @default(uuid())
  gameId             String
  roundNumber        Int
  dealerPosition     Int
  bidderPosition     Int
  bid                Int
  trumpSuit          String
  bidderMadeContract Boolean
  scores             Json
  tricks             Json?
  createdAt          DateTime @default(now())
  game               Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, roundNumber])
  @@index([gameId])
}

model ArenaConfig {
  id           String             @id
  name         String
  provider     String
  difficulty   String
  paramsJson   Json?
  eloRating    Float              @default(1500.0)
  gamesPlayed  Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  participants ArenaParticipant[]

  @@index([eloRating])
  @@index([gamesPlayed])
}

model ArenaMatch {
  id           String             @id @default(uuid())
  status       ArenaMatchStatus   @default(IN_PROGRESS)
  createdAt    DateTime           @default(now())
  completedAt  DateTime?
  participants ArenaParticipant[]

  @@index([status, createdAt])
}

model ArenaParticipant {
  id              String      @id @default(uuid())
  matchId         String
  configId        String
  position        Int
  finalScore      Int
  eloRatingBefore Float
  eloRatingAfter  Float
  eloChange       Float
  config          ArenaConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  match           ArenaMatch  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([matchId, position])
  @@index([matchId])
  @@index([configId])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum GameStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum ArenaMatchStatus {
  IN_PROGRESS
  COMPLETED
  ERROR
}
